<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Photo Organizer</title>
    <style>
        :root {
            --color-primary: #2180a8;
            --color-primary-hover: #1a6b88;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1f2121;
            --color-text-secondary: #626464;
            --color-border: #e0e0e0;
            --color-success: #218041;
            --color-warning: #a84b2f;
            --color-error: #c01547;
            --radius: 8px;
            --space: 16px;
        }

        * {
            box-sizing: border-box;
        }

        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
        }

        body {
            margin: 0;
            padding: var(--space);
            color: var(--color-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: var(--color-surface);
            padding: var(--space);
            border-radius: var(--radius);
            margin-bottom: var(--space);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            color: var(--color-text);
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
            margin: 0;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space);
            margin-bottom: var(--space);
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .upload-section {
            background: var(--color-surface);
            padding: var(--space);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 2px dashed var(--color-primary);
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(33, 128, 168, 0.02);
        }

        .upload-area:hover {
            background: rgba(33, 128, 168, 0.05);
            border-color: var(--color-primary-hover);
        }

        .upload-area.dragover {
            background: rgba(33, 128, 168, 0.1);
            border-color: var(--color-primary-hover);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .upload-area p {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .upload-area strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 4px;
        }

        input[type="file"] {
            display: none;
        }

        .categories {
            margin-top: var(--space);
        }

        .categories h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            color: var(--color-text-secondary);
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .category-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: var(--radius);
            background: var(--color-bg);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .category-item:hover {
            background: rgba(33, 128, 168, 0.05);
        }

        .category-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .category-item label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
        }

        .category-emoji {
            margin-right: 8px;
        }

        .category-group {
            margin-bottom: 16px;
        }

        .category-header {
            font-weight: 600;
            font-size: 13px;
            padding: 8px 10px;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius);
            margin-bottom: 8px;
        }

        .category-sublist {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-left: 8px;
            border-left: 2px solid var(--color-border);
        }

        .category-sublist .category-item {
            padding: 8px;
            background: rgba(33, 128, 168, 0.03);
        }

        .category-sublist .category-item:hover {
            background: rgba(33, 128, 168, 0.08);
        }

        .preview-section {
            background: var(--color-surface);
            padding: var(--space);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 var(--space) 0;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: var(--space);
        }

        .photo-item {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background: var(--color-bg);
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            padding: 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .photo-overlay {
            opacity: 1;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space);
            margin-bottom: var(--space);
        }

        .stat-card {
            background: var(--color-bg);
            padding: var(--space);
            border-radius: var(--radius);
            border-left: 4px solid var(--color-primary);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin: 4px 0 0 0;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 48px var(--space);
            color: var(--color-text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space);
        }

        .export-table th {
            background: var(--color-bg);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 1px solid var(--color-border);
        }

        .export-table td {
            padding: 10px;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* INTERIOR Badges */
        .badge-bathroom {
            background: rgba(59, 130, 246, 0.2);
            color: #1e40af;
        }

        .badge-kitchen {
            background: rgba(249, 115, 22, 0.2);
            color: #7c2d12;
        }

        .badge-living {
            background: rgba(168, 85, 247, 0.2);
            color: #6d28d9;
        }

        .badge-bedrooms {
            background: rgba(236, 72, 153, 0.2);
            color: #831843;
        }

        .badge-flooring {
            background: rgba(107, 114, 128, 0.2);
            color: #374151;
        }

        .badge-drywall {
            background: rgba(148, 163, 184, 0.2);
            color: #334155;
        }

        .badge-insulation {
            background: rgba(100, 116, 139, 0.2);
            color: #1e293b;
        }

        .badge-doors {
            background: rgba(139, 92, 246, 0.2);
            color: #581c87;
        }

        /* EXTERIOR Badges */
        .badge-roofing {
            background: rgba(34, 128, 94, 0.2);
            color: #10522b;
        }

        .badge-siding {
            background: rgba(180, 83, 9, 0.2);
            color: #78350f;
        }

        .badge-windows {
            background: rgba(13, 148, 136, 0.2);
            color: #134e4a;
        }

        .badge-foundation {
            background: rgba(33, 128, 168, 0.2);
            color: #0c4a6e;
        }

        .badge-landscaping {
            background: rgba(34, 197, 94, 0.2);
            color: #166534;
        }

        .badge-gutters {
            background: rgba(59, 130, 246, 0.2);
            color: #1e40af;
        }

        .badge-exterior-paint {
            background: rgba(251, 146, 60, 0.2);
            color: #9a3412;
        }

        /* MEP Badges */
        .badge-plumbing {
            background: rgba(6, 182, 212, 0.2);
            color: #0e7490;
        }

        .badge-electrical {
            background: rgba(255, 193, 7, 0.2);
            color: #f57f17;
        }

        .badge-hvac {
            background: rgba(76, 175, 255, 0.2);
            color: #0d47a1;
        }

        .badge-gas {
            background: rgba(255, 152, 0, 0.2);
            color: #e65100;
        }

        .badge-lowvoltage {
            background: rgba(156, 39, 176, 0.2);
            color: #6a1b9a;
        }

        /* STRUCTURE Badges */
        .badge-framing {
            background: rgba(168, 75, 47, 0.2);
            color: #5d3a1a;
        }

        .badge-concrete {
            background: rgba(120, 144, 156, 0.2);
            color: #37474f;
        }

        .badge-excavation {
            background: rgba(142, 68, 173, 0.2);
            color: #6a1b9a;
        }

        .badge-steel {
            background: rgba(96, 125, 139, 0.2);
            color: #455a64;
        }

        /* FINISHING & DETAILS Badges */
        .badge-trim {
            background: rgba(205, 92, 92, 0.2);
            color: #8b4513;
        }

        .badge-fixtures {
            background: rgba(255, 165, 0, 0.2);
            color: #ff6f00;
        }

        .badge-appliances {
            background: rgba(70, 130, 180, 0.2);
            color: #1a237e;
        }

        .badge-lighting {
            background: rgba(255, 193, 7, 0.2);
            color: #f57f17;
        }

        .badge-final-inspect {
            background: rgba(39, 174, 96, 0.2);
            color: #1b5e20;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--color-border);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-success);
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: var(--space);
            border-radius: var(--radius);
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 var(--space) 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        .modal-close:hover {
            color: var(--color-text);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèóÔ∏è Construction Photo Analyzer</h1>
            <p class="subtitle">Local GPU-powered photo analysis with on-device AI models</p>
            <div style="margin-top: 12px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <div style="font-size: 12px;">
                    <span style="color: #626464;">Backend Status:</span>
                    <span id="serverStatus" style="font-weight: 600; color: #c01547;">‚óè Connecting...</span>
                </div>
                <div style="font-size: 12px;">
                    <span style="color: #626464;">GPU Inference:</span>
                    <span id="gpuStatus" style="font-weight: 600; color: #2180a8;">‚óè Idle</span>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Upload Section -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì§</div>
                    <strong>Click to upload or drag & drop</strong>
                    <p>PNG, JPG, GIF up to 10MB each</p>
                </div>
                <input type="file" id="fileInput" multiple accept="image/*">

                <div class="categories">
                    <h3>Job Categories</h3>
                    <div class="category-list">
                        <!-- INTERIOR -->
                        <div class="category-group">
                            <div class="category-header">üè† Interior</div>
                            <div class="category-sublist">
                                <div class="category-item">
                                    <input type="checkbox" id="cat-bathroom" checked>
                                    <label for="cat-bathroom"><span class="category-emoji">üöø</span>Bathroom</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-kitchen" checked>
                                    <label for="cat-kitchen"><span class="category-emoji">üç≥</span>Kitchen</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-living" checked>
                                    <label for="cat-living"><span class="category-emoji">üõãÔ∏è</span>Living Areas</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-bedrooms" checked>
                                    <label for="cat-bedrooms"><span class="category-emoji">üõèÔ∏è</span>Bedrooms</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-flooring" checked>
                                    <label for="cat-flooring"><span class="category-emoji">ü™µ</span>Flooring</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-drywall" checked>
                                    <label for="cat-drywall"><span class="category-emoji">üìÑ</span>Drywall & Painting</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-insulation" checked>
                                    <label for="cat-insulation"><span class="category-emoji">üßä</span>Insulation</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-doors-hardware" checked>
                                    <label for="cat-doors-hardware"><span class="category-emoji">üö™</span>Doors & Hardware</label>
                                </div>
                            </div>
                        </div>

                        <!-- EXTERIOR -->
                        <div class="category-group">
                            <div class="category-header">üèóÔ∏è Exterior</div>
                            <div class="category-sublist">
                                <div class="category-item">
                                    <input type="checkbox" id="cat-roofing" checked>
                                    <label for="cat-roofing"><span class="category-emoji">üè†</span>Roofing</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-siding" checked>
                                    <label for="cat-siding"><span class="category-emoji">üß±</span>Siding & Cladding</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-windows-doors-ext" checked>
                                    <label for="cat-windows-doors-ext"><span class="category-emoji">ü™ü</span>Windows & Doors</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-foundation" checked>
                                    <label for="cat-foundation"><span class="category-emoji">‚õèÔ∏è</span>Foundation & Basement</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-landscaping" checked>
                                    <label for="cat-landscaping"><span class="category-emoji">üå≥</span>Landscaping & Hardscape</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-gutters" checked>
                                    <label for="cat-gutters"><span class="category-emoji">üíß</span>Gutters & Drainage</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-exterior-paint" checked>
                                    <label for="cat-exterior-paint"><span class="category-emoji">üé®</span>Exterior Paint/Finish</label>
                                </div>
                            </div>
                        </div>

                        <!-- MEP -->
                        <div class="category-group">
                            <div class="category-header">‚ö° MEP Systems</div>
                            <div class="category-sublist">
                                <div class="category-item">
                                    <input type="checkbox" id="cat-plumbing" checked>
                                    <label for="cat-plumbing"><span class="category-emoji">üîß</span>Plumbing</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-electrical" checked>
                                    <label for="cat-electrical"><span class="category-emoji">‚ö°</span>Electrical</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-hvac" checked>
                                    <label for="cat-hvac"><span class="category-emoji">‚ùÑÔ∏è</span>HVAC</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-gas" checked>
                                    <label for="cat-gas"><span class="category-emoji">üî•</span>Natural Gas</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-lowvoltage" checked>
                                    <label for="cat-lowvoltage"><span class="category-emoji">üì°</span>Low Voltage (Data/Telecom)</label>
                                </div>
                            </div>
                        </div>

                        <!-- STRUCTURE -->
                        <div class="category-group">
                            <div class="category-header">üî® Structure</div>
                            <div class="category-sublist">
                                <div class="category-item">
                                    <input type="checkbox" id="cat-framing" checked>
                                    <label for="cat-framing"><span class="category-emoji">ü™µ</span>Framing</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-concrete" checked>
                                    <label for="cat-concrete"><span class="category-emoji">ü™®</span>Concrete Work</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-excavation" checked>
                                    <label for="cat-excavation"><span class="category-emoji">üöú</span>Excavation & Site Work</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-steel" checked>
                                    <label for="cat-steel"><span class="category-emoji">üè≠</span>Structural Steel</label>
                                </div>
                            </div>
                        </div>

                        <!-- FINISHING & DETAILS -->
                        <div class="category-group">
                            <div class="category-header">‚ú® Finishing & Details</div>
                            <div class="category-sublist">
                                <div class="category-item">
                                    <input type="checkbox" id="cat-trim" checked>
                                    <label for="cat-trim"><span class="category-emoji">üìê</span>Trim & Molding</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-fixtures" checked>
                                    <label for="cat-fixtures"><span class="category-emoji">üí°</span>Hardware & Fixtures</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-appliances" checked>
                                    <label for="cat-appliances"><span class="category-emoji">üçΩÔ∏è</span>Appliances</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-lighting" checked>
                                    <label for="cat-lighting"><span class="category-emoji">üí°</span>Lighting</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat-final-inspect" checked>
                                    <label for="cat-final-inspect"><span class="category-emoji">‚úÖ</span>Final Inspection</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <div class="preview-title">Your Photos</div>
                
                <div class="stats" id="stats"></div>

                <div id="photoGrid" class="photo-grid"></div>

                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">üì∏</div>
                    <p>No photos uploaded yet</p>
                    <p style="font-size: 12px; margin-top: 8px;">Upload construction site photos to get started</p>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="analyzeBtn" disabled>ü§ñ Analyze with AI</button>
                    <button class="btn btn-primary" id="exportBtn" disabled>üìä Export as CSV</button>
                    <button class="btn btn-secondary" id="viewExportBtn" disabled>üëÅÔ∏è Preview Export</button>
                    <button class="btn btn-secondary" id="clearBtn" disabled>üóëÔ∏è Clear All</button>
                </div>

                <div id="analysisProgress" style="display: none; margin-top: 16px;">
                    <div style="font-size: 12px; margin-bottom: 8px;">
                        <span id="progressText">Analyzing photos...</span>
                        <span id="progressCount" style="float: right;">0/0</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Export Preview</span>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <table class="export-table" id="exportTable"></table>
        </div>
    </div>

    <script>
        const categories = {
            'Bathroom': {
                keywords: ['bathroom', 'bath', 'shower', 'toilet', 'sink', 'vanity', 'tile'],
                badge: 'badge-bathroom'
            },
            'Kitchen': {
                keywords: ['kitchen', 'cabinet', 'countertop', 'sink', 'stove', 'oven', 'range'],
                badge: 'badge-kitchen'
            },
            'Living Areas': {
                keywords: ['living', 'den', 'family', 'room', 'hallway', 'foyer', 'entry'],
                badge: 'badge-living'
            },
            'Bedrooms': {
                keywords: ['bedroom', 'master', 'bed', 'bedroom suite', 'bedroom closet'],
                badge: 'badge-bedrooms'
            },
            'Flooring': {
                keywords: ['floor', 'flooring', 'hardwood', 'laminate', 'vinyl', 'carpet', 'tile floor'],
                badge: 'badge-flooring'
            },
            'Drywall & Painting': {
                keywords: ['drywall', 'paint', 'painting', 'wall', 'primer', 'mudding', 'taping'],
                badge: 'badge-drywall'
            },
            'Insulation': {
                keywords: ['insulation', 'insulate', 'batt', 'fiberglass', 'foam', 'blanket'],
                badge: 'badge-insulation'
            },
            'Doors & Hardware': {
                keywords: ['door', 'doors', 'hardware', 'hinge', 'knob', 'handle', 'lock'],
                badge: 'badge-doors'
            },
            'Roofing': {
                keywords: ['roof', 'roofing', 'shingle', 'truss', 'rafter', 'ridge', 'membrane'],
                badge: 'badge-roofing'
            },
            'Siding & Cladding': {
                keywords: ['siding', 'cladding', 'brick', 'stone', 'vinyl', 'hardie', 'exterior wall'],
                badge: 'badge-siding'
            },
            'Windows & Doors': {
                keywords: ['window', 'windows', 'door', 'exterior door', 'patio door', 'french door'],
                badge: 'badge-windows'
            },
            'Foundation & Basement': {
                keywords: ['foundation', 'footing', 'basement', 'concrete', 'excavation', 'footer'],
                badge: 'badge-foundation'
            },
            'Landscaping & Hardscape': {
                keywords: ['landscape', 'landscaping', 'hardscape', 'patio', 'deck', 'driveway', 'walkway', 'gravel'],
                badge: 'badge-landscaping'
            },
            'Gutters & Drainage': {
                keywords: ['gutter', 'downspout', 'drainage', 'drain', 'sump', 'grading'],
                badge: 'badge-gutters'
            },
            'Exterior Paint/Finish': {
                keywords: ['exterior paint', 'exterior finish', 'stain', 'sealant', 'caulk'],
                badge: 'badge-exterior-paint'
            },
            'Plumbing': {
                keywords: ['plumbing', 'pipe', 'plumber', 'water', 'drain', 'pvc', 'copper'],
                badge: 'badge-plumbing'
            },
            'Electrical': {
                keywords: ['electrical', 'electric', 'wire', 'conduit', 'breaker', 'outlet', 'panel', 'light'],
                badge: 'badge-electrical'
            },
            'HVAC': {
                keywords: ['hvac', 'heating', 'cooling', 'air conditioning', 'furnace', 'ductwork', 'duct'],
                badge: 'badge-hvac'
            },
            'Natural Gas': {
                keywords: ['gas', 'natural gas', 'propane', 'line', 'heater', 'fireplace'],
                badge: 'badge-gas'
            },
            'Low Voltage (Data/Telecom)': {
                keywords: ['data', 'telecom', 'ethernet', 'cat5', 'cat6', 'fiber', 'communication', 'low voltage'],
                badge: 'badge-lowvoltage'
            },
            'Framing': {
                keywords: ['frame', 'framing', 'stud', 'beam', 'joist', 'rafter', 'lumber', 'skeleton'],
                badge: 'badge-framing'
            },
            'Concrete Work': {
                keywords: ['concrete', 'concrete work', 'pour', 'slab', 'sidewalk', 'cement'],
                badge: 'badge-concrete'
            },
            'Excavation & Site Work': {
                keywords: ['excavation', 'excavate', 'site work', 'grading', 'clearing', 'equipment'],
                badge: 'badge-excavation'
            },
            'Structural Steel': {
                keywords: ['steel', 'structural steel', 'beam', 'column', 'welding', 'fabrication'],
                badge: 'badge-steel'
            },
            'Trim & Molding': {
                keywords: ['trim', 'molding', 'baseboard', 'crown', 'casing', 'wainscot'],
                badge: 'badge-trim'
            },
            'Hardware & Fixtures': {
                keywords: ['hardware', 'fixture', 'fixtures', 'faucet', 'light fixture', 'outlet cover'],
                badge: 'badge-fixtures'
            },
            'Appliances': {
                keywords: ['appliance', 'appliances', 'refrigerator', 'dishwasher', 'stove', 'microwave'],
                badge: 'badge-appliances'
            },
            'Lighting': {
                keywords: ['lighting', 'light', 'fixture', 'chandelier', 'pendant', 'recessed'],
                badge: 'badge-lighting'
            },
            'Final Inspection': {
                keywords: ['inspection', 'inspector', 'inspect', 'approved', 'passed', 'final', 'certificate'],
                badge: 'badge-final-inspect'
            }
        };

        let photos = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const photoGrid = document.getElementById('photoGrid');
        const emptyState = document.getElementById('emptyState');
        const exportBtn = document.getElementById('exportBtn');
        const viewExportBtn = document.getElementById('viewExportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const stats = document.getElementById('stats');

        // Upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const photoName = file.name;
                    const detectedCategory = detectCategory(photoName);
                    
                    photos.push({
                        id: Date.now() + Math.random(),
                        name: photoName,
                        src: e.target.result,
                        category: detectedCategory,
                        uploadDate: new Date().toLocaleDateString()
                    });

                    render();
                };
                reader.readAsDataURL(file);
            });
        }

        function detectCategory(filename) {
            const lowerName = filename.toLowerCase();
            
            for (const [category, data] of Object.entries(categories)) {
                for (const keyword of data.keywords) {
                    if (lowerName.includes(keyword)) {
                        return category;
                    }
                }
            }
            
            return 'Final Inspection'; // Default category
        }

        function render() {
            // Update empty state
            emptyState.style.display = photos.length === 0 ? 'block' : 'none';

            // Render photos
            photoGrid.innerHTML = photos.map(photo => {
                const badgeClass = categories[photo.category].badge;
                return `
                    <div class="photo-item">
                        <img src="${photo.src}" alt="${photo.name}">
                        <div class="photo-overlay">
                            <span class="badge ${badgeClass}">${photo.category}</span>
                            <button class="btn btn-secondary" style="margin-left: 4px; padding: 4px 8px; font-size: 12px;" onclick="deletePhoto(${photo.id})">√ó</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Render stats
            const categoryCounts = {};
            photos.forEach(p => {
                categoryCounts[p.category] = (categoryCounts[p.category] || 0) + 1;
            });

            stats.innerHTML = `
                <div class="stat-card">
                    <p class="stat-number">${photos.length}</p>
                    <p class="stat-label">Total Photos</p>
                </div>
                ${Object.entries(categoryCounts).map(([cat, count]) => `
                    <div class="stat-card">
                        <p class="stat-number">${count}</p>
                        <p class="stat-label">${cat}</p>
                    </div>
                `).join('')}
            `;

            // Update button states
            const hasPhotos = photos.length > 0;
            exportBtn.disabled = !hasPhotos;
            viewExportBtn.disabled = !hasPhotos;
            clearBtn.disabled = !hasPhotos;
        }

        function deletePhoto(id) {
            photos = photos.filter(p => p.id !== id);
            render();
        }

        exportBtn.addEventListener('click', () => {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `construction-photos-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        viewExportBtn.addEventListener('click', () => {
            const table = document.getElementById('exportTable');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Photo Name</th>
                        <th>Category</th>
                        <th>Upload Date</th>
                    </tr>
                </thead>
                <tbody>
                    ${photos.map(p => `
                        <tr>
                            <td>${p.name}</td>
                            <td><span class="badge ${categories[p.category].badge}">${p.category}</span></td>
                            <td>${p.uploadDate}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            document.getElementById('exportModal').classList.add('active');
        });

        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all photos?')) {
                photos = [];
                render();
            }
        });

        function generateCSV() {
            const headers = ['Photo Name', 'Category', 'Upload Date'];
            const rows = photos.map(p => [p.name, p.category, p.uploadDate]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function closeModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // ========== LOCAL BACKEND INTEGRATION ==========
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        const HEALTH_URL = 'http://localhost:8000/health';
        
        let analysisInProgress = false;
        let serverConnected = false;

        // Check backend connection on load
        async function checkServerStatus() {
            try {
                const response = await fetch(HEALTH_URL, { 
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    serverConnected = true;
                    updateServerStatus(true, data);
                } else {
                    serverConnected = false;
                    updateServerStatus(false);
                }
            } catch (error) {
                console.error('Server connection error:', error);
                serverConnected = false;
                updateServerStatus(false);
            }
            
            // Retry every 5 seconds
            setTimeout(checkServerStatus, 5000);
        }

        function updateServerStatus(connected, data = null) {
            const statusEl = document.getElementById('serverStatus');
            if (connected) {
                const gpuText = data?.cuda_available ? ' (GPU)' : ' (CPU)';
                statusEl.textContent = '‚óè Connected' + gpuText;
                statusEl.style.color = '#218041';
                document.getElementById('analyzeBtn').disabled = photos.length === 0;
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.style.color = '#c01547';
                document.getElementById('analyzeBtn').disabled = true;
            }
        }

        function updateGPUStatus(status, message = '') {
            const gpuEl = document.getElementById('gpuStatus');
            if (status === 'processing') {
                gpuEl.textContent = '‚óè Processing' + (message ? ` (${message})` : '');
                gpuEl.style.color = '#a84b2f';
            } else if (status === 'ready') {
                gpuEl.textContent = '‚óè Ready';
                gpuEl.style.color = '#218041';
            } else if (status === 'error') {
                gpuEl.textContent = '‚óè Error';
                gpuEl.style.color = '#c01547';
            } else {
                gpuEl.textContent = '‚óè Idle';
                gpuEl.style.color = '#2180a8';
            }
        }

        // Base64 to Blob conversion helper
        function base64ToBlob(base64, mimeType) {
            // Remove data URL prefix if present
            const base64Data = base64.includes(',') ? base64.split(',')[1] : base64;
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // Get MIME type from data URL or filename
        function getMimeType(dataUrl, filename) {
            if (dataUrl.startsWith('data:')) {
                const match = dataUrl.match(/data:([^;]+);/);
                if (match) return match[1];
            }
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'webp': 'image/webp',
                'gif': 'image/gif'
            };
            return mimeTypes[ext] || 'image/jpeg';
        }

        // Send photos to backend for AI analysis
        async function analyzePhotosWithAI() {
            if (analysisInProgress || photos.length === 0 || !serverConnected) return;
            
            analysisInProgress = true;
            updateGPUStatus('processing');
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('progressText').textContent = 'Analyzing photos...';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressCount').textContent = `0/${photos.length}`;

            const startTime = performance.now();
            let completed = 0;
            let successful = 0;
            let errors = [];

            try {
                // Use batch endpoint for multiple photos
                if (photos.length > 1) {
                    // Create FormData with all images
                    const formData = new FormData();
                    
                    for (const photo of photos) {
                        const mimeType = getMimeType(photo.src, photo.name);
                        const blob = base64ToBlob(photo.src, mimeType);
                        formData.append('files', blob, photo.name);
                    }
                    
                    updateGPUStatus('processing', 'batch');
                    
                    const response = await fetch(`${API_BASE_URL}/batch-analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Batch analysis result:', result);
                    
                    // Update photos with results
                    if (result.results) {
                        result.results.forEach((res, index) => {
                            if (res.success && res.analysis) {
                                const photo = photos.find(p => p.name === res.filename);
                                if (photo) {
                                    // Map backend category to frontend category
                                    photo.category = mapBackendCategory(res.analysis.construction_category);
                                    photo.confidence = res.analysis.confidence;
                                    photo.aiDetected = true;
                                    photo.predictions = res.analysis.classifications;
                                    successful++;
                                }
                            } else {
                                errors.push({ filename: res.filename, error: res.error });
                            }
                            completed++;
                            const progress = (completed / photos.length) * 100;
                            document.getElementById('progressFill').style.width = progress + '%';
                            document.getElementById('progressCount').textContent = `${completed}/${photos.length}`;
                        });
                    }
                } else {
                    // Single image analysis
                    const photo = photos[0];
                    const mimeType = getMimeType(photo.src, photo.name);
                    const blob = base64ToBlob(photo.src, mimeType);
                    
                    const formData = new FormData();
                    formData.append('file', blob, photo.name);
                    
                    updateGPUStatus('processing', 'single');
                    
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('Single analysis result:', result);
                    
                    if (result.success && result.analysis) {
                        photo.category = mapBackendCategory(result.analysis.construction_category);
                        photo.confidence = result.analysis.confidence;
                        photo.aiDetected = true;
                        photo.predictions = result.analysis.classifications;
                        successful++;
                    }
                    
                    completed++;
                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('progressCount').textContent = `1/1`;
                }
                
                const endTime = performance.now();
                const totalTime = ((endTime - startTime) / 1000).toFixed(2);
                
                render();
                
                const errorMsg = errors.length > 0 
                    ? `\n\nFailed: ${errors.map(e => `${e.filename}: ${e.error}`).join('\n')}` 
                    : '';
                
                alert(`Analysis complete!\n\n‚úÖ ${successful}/${photos.length} photos analyzed\n‚è±Ô∏è Total time: ${totalTime}s${errorMsg}`);

            } catch (error) {
                console.error('Error during analysis:', error);
                updateGPUStatus('error');
                alert(`Analysis failed: ${error.message}\n\nMake sure the backend server is running.`);
            } finally {
                analysisInProgress = false;
                updateGPUStatus('ready');
                document.getElementById('analysisProgress').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = photos.length === 0;
            }
        }

        // Map backend construction categories to frontend categories
        function mapBackendCategory(backendCategory) {
            const categoryMap = {
                'Foundation & Excavation': 'Foundation & Basement',
                'Framing & Structure': 'Framing',
                'Roofing': 'Roofing',
                'Electrical & Plumbing': 'Electrical',
                'Interior Finishing': 'Drywall & Painting',
                'Exterior & Landscaping': 'Landscaping & Hardscape',
                'Safety & Equipment': 'Excavation & Site Work',
                'Progress Documentation': 'Final Inspection',
                'Uncategorized': 'Final Inspection'
            };
            
            return categoryMap[backendCategory] || 'Final Inspection';
        }

        // Update button rendering
        const originalRender = render;
        function render() {
            originalRender();
            
            // Update analyze button state
            const hasPhotos = photos.length > 0;
            document.getElementById('analyzeBtn').disabled = !hasPhotos || analysisInProgress || !serverConnected;
        }

        // Fetch categories from backend
        async function fetchCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/categories`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Available categories:', data.categories);
                }
            } catch (error) {
                console.log('Could not fetch categories from backend');
            }
        }

        // Fetch stats from backend
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Stats:', data);
                    
                    // Update GPU status based on stats
                    if (data.gpu?.available) {
                        updateGPUStatus('ready');
                    }
                }
            } catch (error) {
                console.log('Could not fetch stats from backend');
            }
        }

        // Attach event listeners
        document.getElementById('analyzeBtn').addEventListener('click', analyzePhotosWithAI);

        // Initialize
        checkServerStatus();
        fetchCategories();
        fetchStats();
        
        // Initial render
        render();
    </script>
</body>
</html>
